<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge-Weaver Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css?v=2">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üï∑Ô∏è</text></svg>">
</head>

<body>
    <header>
        <div class="logo-container">
            <span class="logo-icon">üï∑Ô∏è</span>
            <h1>Knowledge-Weaver</h1>
        </div>
        <div class="header-controls">
            <span class="status-badge" data-testid="connection-status">Connecting...</span>
        </div>
    </header>

    <main>
        <!-- Metrics Section -->
        <section class="metrics-grid" aria-label="Dashboard Metrics">
            <div class="metric-card" data-testid="metric-total-knowledge">
                <h3>Total Knowledge</h3>
                <div class="value">--</div>
            </div>
            <div class="metric-card" data-testid="metric-verified-ratio">
                <h3>Verified Ratio</h3>
                <div class="value">--%</div>
            </div>
            <div class="metric-card" data-testid="metric-query-volume">
                <h3>Query Volume (7d)</h3>
                <div class="value">--</div>
            </div>
            <div class="metric-card" data-testid="metric-knowledge-gaps">
                <h3>Knowledge Gaps (7d)</h3>
                <div class="value">--</div>
            </div>
        </section>

        <!-- Bridge the Gap Section -->
        <section class="dashboard-section" aria-label="Bridge the Gap">
            <div class="section-header">
                <h2>Bridge the Gap</h2>
                <p>Identify and resolve missing knowledge topics.</p>
            </div>

            <div class="gap-workflow">
                <div class="gap-list-container">
                    <h3>Missing Topics</h3>
                    <div class="gap-list" id="gap-list" data-testid="gap-list">
                        <!-- Gaps will be injected here -->
                        <div class="loading-spinner">Loading gaps...</div>
                    </div>
                </div>

                <div class="gap-action-container">
                    <h3>Provide Answer</h3>
                    <form id="gap-answer-form" data-testid="gap-answer-form">
                        <div class="selected-gap-display" id="selected-gap-display" data-testid="selected-gap-display">
                            Select a gap to answer...
                        </div>
                        <input type="hidden" id="selected-gap-query">

                        <div class="form-group">
                            <label for="answer-content">Answer Content</label>
                            <textarea id="answer-content" name="answer-content" rows="6"
                                placeholder="Type the verified answer here..." data-testid="answer-input"
                                disabled></textarea>
                        </div>

                        <div class="form-group">
                            <label for="gap-screenshot-input">Attach Screenshot (Optional)</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="file" id="gap-screenshot-input" accept="image/*" disabled style="flex: 1;">
                                <button type="button" class="btn-secondary" id="gap-auto-redact-btn" disabled
                                    style="padding: 8px 12px; font-size: 0.9rem; white-space: nowrap;">
                                    ‚ú® Auto-Redact (HIPAA)
                                </button>
                                <button type="button" class="btn-secondary" id="gap-keep-btn"
                                    style="padding: 8px 12px; font-size: 0.9rem; white-space: nowrap; display: none; background-color: #00C853; color: white; border-color: #00C853;">
                                    üõ°Ô∏è Keep Protected
                                </button>
                                <button type="button" class="btn-secondary" id="gap-revert-btn"
                                    style="padding: 8px 12px; font-size: 0.9rem; white-space: nowrap; display: none; border-color: #F85149; color: #F85149;">
                                    ‚ö†Ô∏è Revert
                                </button>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary" data-testid="submit-answer-btn" disabled>
                                Submit Answer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Learning Activity Section -->
        <section class="dashboard-section" aria-label="Learning Activity">
            <div class="section-header">
                <h2>Learning Activity</h2>
                <p>Recent human corrections that trained the AI.</p>
            </div>
            <div class="learning-dashboard-grid">
                <div class="learning-feed-container">
                    <h3>üß† AI Learning Log</h3>
                    <div class="table-container">
                        <table class="knowledge-table" data-testid="learning-table">
                            <thead>
                                <tr>
                                    <th>Original Draft</th>
                                    <th>Human Correction</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="learning-table-body">
                                <!-- Learning rows injected here -->
                                <tr>
                                    <td colspan="3" class="loading-spinner">Loading history...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="learning-chart-container">
                    <h3>Top Learned Topics</h3>
                    <canvas id="learning-chart"></canvas>
                </div>
                <div class="learning-chart-container">
                    <h3>üß† Cognitive Health</h3>
                    <canvas id="cognitive-health-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- Knowledge Base Section -->
        <section class="dashboard-section" aria-label="Knowledge Base">
            <div class="section-header">
                <div class="tabs">
                    <button class="tab-btn active" id="tab-active" data-testid="tab-active">Active
                        Knowledge</button>
                    <button class="tab-btn" id="tab-recycle" data-testid="tab-recycle">Recycle Bin
                        üóëÔ∏è</button>
                </div>
                <button class="btn-secondary" id="refresh-knowledge-btn"
                    data-testid="refresh-knowledge-btn">Refresh</button>
            </div>

            <!-- Active Knowledge Table -->
            <div id="active-knowledge-view" class="table-container">
                <table class="knowledge-table" data-testid="knowledge-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Content/Summary</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="knowledge-table-body">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>

            <!-- Recycle Bin Table -->
            <div id="recycle-bin-view" class="table-container hidden">
                <div class="empty-state-container" id="recycle-empty-state" style="display: none;">
                    <p>Recycle bin is empty.</p>
                </div>
                <table class="knowledge-table" data-testid="recycle-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Content/Summary</th>
                            <th>Category</th>
                            <th>Deleted At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recycle-table-body">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Edit Modal -->
    <dialog id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Knowledge Entry</h2>
                <button class="close-btn" id="close-modal-btn" data-testid="close-modal-btn">&times;</button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-id">

                <div class="form-group">
                    <label for="edit-category">Category</label>
                    <input type="text" id="edit-category" required data-testid="edit-category-input">
                </div>

                <div class="form-group">
                    <label for="edit-tags">Tags (comma separated)</label>
                    <input type="text" id="edit-tags" data-testid="edit-tags-input">
                </div>

                <div class="form-group">
                    <label for="edit-summary">Summary</label>
                    <textarea id="edit-summary" rows="3" data-testid="edit-summary-input"></textarea>
                </div>

                <div class="form-group">
                    <label for="edit-content-input">Content</label>
                    <textarea id="edit-content-input" class="input-field" rows="6"
                        placeholder="Full verified answer..."></textarea>
                </div>

                <div class="form-group">
                    <label>Current Screenshot</label>
                    <img id="edit-image-preview" src="" style="display:none; max-width: 100%; margin-bottom: 10px;">
                    <img id="edit-current-image"
                        style="max-width: 100%; display: none; margin-bottom: 10px; border-radius: 4px; border: 1px solid var(--border-color);">

                    <label for="edit-screenshot">Update Screenshot</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="edit-screenshot" accept="image/*" data-testid="edit-screenshot-input"
                            style="flex: 1;">
                        <button type="button" class="btn-secondary" id="edit-auto-redact-btn"
                            style="padding: 8px 12px; font-size: 0.9rem; white-space: nowrap; display: none;">
                            ‚ú® Auto-Redact (HIPAA)
                        </button>
                        <button type="button" class="btn-secondary" id="edit-keep-btn"
                            style="padding: 8px 12px; font-size: 0.9rem; white-space: nowrap; display: none; background-color: #00C853; color: white; border-color: #00C853;">
                            üõ°Ô∏è Keep Protected
                        </button>
                        <button type="button" class="btn-secondary" id="edit-revert-btn"
                            style="padding: 8px 12px; font-size: 0.9rem; white-space: nowrap; display: none; border-color: #F85149; color: #F85149;">
                            ‚ö†Ô∏è Revert
                        </button>
                    </div>
                    <div id="edit-preview-container" style="margin-top: 10px; display: none;">
                        <img id="edit-preview" src="" alt="Screenshot Preview"
                            style="max-width: 100%; max-height: 200px; border-radius: 4px; border: 1px solid var(--border-color);">
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="cancel-edit-btn"
                        data-testid="cancel-edit-btn">Cancel</button>
                    <button type="submit" class="btn-primary" id="save-edit-btn" data-testid="save-changes-btn">Save
                        Changes</button>
                </div>
            </form>
        </div>
    </dialog>

    <!-- Image View Modal -->
    <dialog id="image-modal" class="modal">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; width: auto;">
            <div class="modal-header">
                <h2>Captured Screenshot</h2>
                <button class="close-btn" id="close-image-modal-btn">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center; overflow: auto;">
                <img id="full-size-image" src="" alt="Full size screenshot" style="max-width: 100%; height: auto;">
            </div>
        </div>
    </dialog>
    <!-- Redaction Modal -->
    <dialog id="redaction-modal" class="modal">
        <div class="modal-content" style="max-width: 90vw; width: auto;">
            <div class="modal-header">
                <h2>Redact Sensitive Information</h2>
                <button class="close-btn" id="close-redaction-modal-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p>AI has automatically redacted detected PII. Please review and draw additional black boxes if needed.
                </p>
                <div class="toolbar" style="margin-bottom: 10px;">
                    <button type="button" class="btn-secondary active" id="tool-rect"
                        style="background-color: #333; color: white;">‚¨õ Draw Black Box</button>
                    <button type="button" class="btn-secondary" id="tool-undo">‚Ü©Ô∏è Undo</button>
                    <button type="button" class="btn-secondary" id="tool-reset">üîÑ Reset to AI Draft</button>
                </div>
                <div class="canvas-container"
                    style="position: relative; overflow: auto; max-height: 50vh; border: 1px solid #ccc; margin-bottom: 15px;">
                    <canvas id="redaction-canvas"></canvas>
                </div>

                <!-- Redaction Acceptance Controls -->
                <div class="redaction-controls"
                    style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0; font-size: 1rem;">Version Control</h3>
                        <span id="redaction-status-badge" class="badge"
                            style="background-color: #00C853; color: white;">üõ°Ô∏è Protected</span>
                    </div>
                    <div class="button-group" style="display: flex; gap: 10px;">
                        <button type="button" class="btn-secondary active" id="btn-keep-redacted"
                            data-testid="btn-keep-redacted" style="flex: 1; border-color: #00C853;">
                            üõ°Ô∏è Keep Protected Version
                        </button>
                        <button type="button" class="btn-secondary" id="btn-revert-original"
                            data-testid="btn-revert-original" style="flex: 1;">
                            ‚ö†Ô∏è Revert to Original
                        </button>
                    </div>
                    <p id="redaction-help-text"
                        style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 10px; margin-bottom: 0;">
                        Confirming the protected version ensures PII is removed before saving.
                    </p>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 15px;">
                <button type="button" class="btn-secondary" id="cancel-redaction-btn">Cancel</button>
                <button type="button" class="btn-primary" id="save-redaction-btn">Save Redacted Image</button>
            </div>
        </div>
    </dialog>


    <script src="app.js?v=4"></script>
</body>

</html>